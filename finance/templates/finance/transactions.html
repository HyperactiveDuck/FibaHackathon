{% extends 'base.html' %}

{% block page_title %}Transactions{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px;">
    <form method="GET" id="filterForm" style="display: flex; gap: 16px; align-items: center;">
        <select name="account" onchange="submitFilters()" style="
            background-color: #111111;
            border: 1px solid #27272a;
            color: #e4e4e7;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
        ">
            <option value="">All Accounts</option>
            {% for account in accounts %}
            <option value="{{ account.pk }}" {% if request.GET.account == account.pk|stringformat:"s" %}selected{% endif %}>
                {{ account.bank_name }}{% if account.account_type %} ({{ account.account_type }}){% endif %}
            </option>
            {% endfor %}
        </select>
        
        <select name="date_range" onchange="submitFilters()" style="
            background-color: #111111;
            border: 1px solid #27272a;
            color: #e4e4e7;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
        ">
            <option value="30" {% if request.GET.date_range == "30" or not request.GET.date_range %}selected{% endif %}>Last 30 days</option>
            <option value="7" {% if request.GET.date_range == "7" %}selected{% endif %}>Last 7 days</option>
            <option value="90" {% if request.GET.date_range == "90" %}selected{% endif %}>Last 90 days</option>
            <option value="this_month" {% if request.GET.date_range == "this_month" %}selected{% endif %}>This month</option>
            <option value="last_month" {% if request.GET.date_range == "last_month" %}selected{% endif %}>Last month</option>
            <option value="all" {% if request.GET.date_range == "all" %}selected{% endif %}>All time</option>
        </select>
        
        <select name="category" onchange="submitFilters()" style="
            background-color: #111111;
            border: 1px solid #27272a;
            color: #e4e4e7;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
        ">
            <option value="">All Categories</option>
            <option value="FOOD_DINING" {% if request.GET.category == "FOOD_DINING" %}selected{% endif %}>Food & Dining</option>
            <option value="SHOPPING" {% if request.GET.category == "SHOPPING" %}selected{% endif %}>Shopping</option>
            <option value="TRANSPORTATION" {% if request.GET.category == "TRANSPORTATION" %}selected{% endif %}>Transportation</option>
            <option value="BILLS_UTILITIES" {% if request.GET.category == "BILLS_UTILITIES" %}selected{% endif %}>Bills & Utilities</option>
            <option value="ENTERTAINMENT" {% if request.GET.category == "ENTERTAINMENT" %}selected{% endif %}>Entertainment</option>
            <option value="TRANSFER" {% if request.GET.category == "TRANSFER" %}selected{% endif %}>Transfer</option>
            <option value="OTHER" {% if request.GET.category == "OTHER" %}selected{% endif %}>Other</option>
        </select>
        
        <input type="text" name="search" value="{{ request.GET.search }}" placeholder="Search transactions..." 
               onkeyup="delayedSubmit()" style="
            background-color: #111111;
            border: 1px solid #27272a;
            color: #e4e4e7;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
            min-width: 200px;
        ">
        
        {% if request.GET.account or request.GET.category or request.GET.search or request.GET.date_range != "30" %}
        <button type="button" onclick="clearFilters()" style="
            background-color: #ef4444;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        " onmouseover="this.style.backgroundColor='#dc2626'" onmouseout="this.style.backgroundColor='#ef4444'">
            Clear
        </button>
        {% endif %}
    </form>
    
    <button onclick="exportCSV()" style="
        background-color: #22c55e;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        font-weight: 500;
        cursor: pointer;
        transition: background-color 0.2s ease;
    " onmouseover="this.style.backgroundColor='#16a34a'" onmouseout="this.style.backgroundColor='#22c55e'">
        Export CSV
    </button>
</div>

<div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); margin-bottom: 32px;">
    <div class="card">
        <h3>Total Inflow</h3>
        <div class="metric-value metric-positive">â‚º{{ total_inflow|floatformat:2 }}</div>
        <p style="color: #a1a1aa; font-size: 12px; margin-top: 4px;">Income transactions</p>
    </div>
    
    <div class="card">
        <h3>Total Outflow</h3>
        <div class="metric-value metric-negative">â‚º{{ total_outflow|floatformat:2 }}</div>
        <p style="color: #a1a1aa; font-size: 12px; margin-top: 4px;">Expense transactions</p>
    </div>
    
    <div class="card">
        <h3>Net Change</h3>
        <div class="metric-value {% if net_change >= 0 %}metric-positive{% else %}metric-negative{% endif %}">
            {% if net_change >= 0 %}+{% endif %}â‚º{{ net_change|floatformat:2 }}
        </div>
        <p style="color: #a1a1aa; font-size: 12px; margin-top: 4px;">Balance change</p>
    </div>
    
    <div class="card">
        <h3>Total Transactions</h3>
        <div class="metric-value metric-neutral">{{ transaction_count }}</div>
        <p style="color: #a1a1aa; font-size: 12px; margin-top: 4px;">All time</p>
    </div>
</div>

<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
        <h3 class="section-title" style="margin-bottom: 0;">Recent Transactions</h3>
        <p style="color: #71717a; font-size: 12px;">Showing {{ transactions|length }} of {{ transaction_count }} transactions</p>
    </div>
    
    <div id="transactionsList">
        {% for transaction in transactions %}
        <div class="transaction-item" style="
            border-bottom: 1px solid #27272a; 
            padding: 16px 0; 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            {% if forloop.counter > 5 %}display: none;{% endif %}
        " data-index="{{ forloop.counter }}">
            <div style="display: flex; align-items: center; gap: 16px;">
                <div style="
                    width: 40px;
                    height: 40px;
                    background-color: {% if transaction.amount >= 0 %}#22c55e20{% else %}#ef444420{% endif %};
                    border-radius: 8px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 18px;
                ">
                    {% if transaction.category == 'FOOD_DINING' %}ðŸ•
                    {% elif transaction.category == 'SHOPPING' %}ðŸ›’
                    {% elif transaction.category == 'TRANSPORTATION' %}ðŸš‡
                    {% elif transaction.category == 'BILLS_UTILITIES' %}âš¡
                    {% elif transaction.category == 'ENTERTAINMENT' %}ðŸŽ¬
                    {% elif transaction.amount >= 0 %}ðŸ’°
                    {% else %}ðŸ’³
                    {% endif %}
                </div>
                <div>
                    <h4 style="color: #fafafa; font-size: 14px; margin-bottom: 2px;">
                        {{ transaction.merchant|default:transaction.description }}
                    </h4>
                    <p style="color: #71717a; font-size: 12px;">
                        {% if transaction.category == 'FOOD_DINING' %}Food & Dining
                        {% elif transaction.category == 'SHOPPING' %}Shopping
                        {% elif transaction.category == 'TRANSPORTATION' %}Transportation
                        {% elif transaction.category == 'BILLS_UTILITIES' %}Bills & Utilities
                        {% elif transaction.category == 'ENTERTAINMENT' %}Entertainment
                        {% else %}{{ transaction.category }}
                        {% endif %}
                        â€¢ {{ transaction.account.bank_name }} {{ transaction.account.get_account_type_display }}
                    </p>
                    <p style="color: #71717a; font-size: 11px;">Transaction ID: {{ transaction.transaction_id }}</p>
                </div>
            </div>
            <div style="text-align: right;">
                <p style="color: {% if transaction.amount >= 0 %}#22c55e{% else %}#ef4444{% endif %}; font-size: 16px; font-weight: 600;">
                    {% if transaction.amount >= 0 %}+{% endif %}â‚º{{ transaction.amount|floatformat:2 }}
                </p>
                <p style="color: #a1a1aa; font-size: 12px;">{{ transaction.date|date:"M j, Y H:i" }}</p>
                <span style="
                    background-color: {% if transaction.amount >= 0 %}#22c55e20{% else %}#ef444420{% endif %};
                    color: {% if transaction.amount >= 0 %}#22c55e{% else %}#ef4444{% endif %};
                    padding: 2px 6px;
                    border-radius: 4px;
                    font-size: 10px;
                    text-transform: uppercase;
                ">{% if transaction.amount >= 0 %}Credit{% else %}Debit{% endif %}</span>
            </div>
        </div>
        {% empty %}
        <div style="text-align: center; padding: 40px; color: #71717a;">
            <p>No transactions found</p>
        </div>
        {% endfor %}
    </div>
    
    {% if transactions|length > 5 %}
    <div style="text-align: center; margin-top: 24px;">
        <button id="toggleTransactions" onclick="toggleTransactionsList()" style="
            background-color: #27272a;
            color: #e4e4e7;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 0 auto;
        " onmouseover="this.style.backgroundColor='#3f3f46'" onmouseout="this.style.backgroundColor='#27272a'">
            <span id="toggleText">Show More</span>
            <span id="toggleIcon" style="transition: transform 0.2s ease;">â–¼</span>
        </button>
    </div>
    {% endif %}
</div>

<script>
let searchTimeout;

function submitFilters() {
    document.getElementById('filterForm').submit();
}

function delayedSubmit() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
        document.getElementById('filterForm').submit();
    }, 500);
}

function clearFilters() {
    const form = document.getElementById('filterForm');
    const selects = form.querySelectorAll('select');
    const inputs = form.querySelectorAll('input');
    
    selects.forEach(select => {
        select.selectedIndex = 0;
    });
    
    inputs.forEach(input => {
        input.value = '';
    });
    
    form.submit();
}

function exportCSV() {
    const form = document.getElementById('filterForm');
    const formData = new FormData(form);
    const params = new URLSearchParams(formData);
    
    params.append('export', 'csv');
    
    const url = window.location.pathname + '?' + params.toString();
    window.location.href = url;
}

function toggleTransactionsList() {
    const hiddenItems = document.querySelectorAll('.transaction-item[data-index]');
    const toggleBtn = document.getElementById('toggleTransactions');
    const toggleText = document.getElementById('toggleText');
    const toggleIcon = document.getElementById('toggleIcon');
    
    let isExpanded = toggleText.textContent === 'Show Less';
    
    hiddenItems.forEach((item, index) => {
        const itemIndex = parseInt(item.getAttribute('data-index'));
        
        if (itemIndex > 5) {
            if (isExpanded) {
                item.style.display = 'none';
                item.style.opacity = '0';
            } else {
                item.style.display = 'flex';
                setTimeout(() => {
                    item.style.opacity = '1';
                }, 50 * (itemIndex - 5));
            }
        }
    });
    
    if (isExpanded) {
        toggleText.textContent = 'Show More';
        toggleIcon.style.transform = 'rotate(0deg)';
    } else {
        toggleText.textContent = 'Show Less';
        toggleIcon.style.transform = 'rotate(180deg)';
    }
}

document.addEventListener('DOMContentLoaded', function() {
    const transactionItems = document.querySelectorAll('.transaction-item');
    transactionItems.forEach(item => {
        item.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
        if (item.style.display !== 'none') {
            item.style.opacity = '1';
        }
    });
});
</script>
{% endblock %}