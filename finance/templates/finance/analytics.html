{% extends 'base.html' %}

{% block page_title %}Analytics{% endblock %}

{% block content %}
<!-- Header with time period selector -->
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px;">
    <div style="display: flex; gap: 16px; align-items: center;">
        <select style="
            background-color: #111111;
            border: 1px solid #27272a;
            color: #e4e4e7;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
        ">
            <option>Last 12 months</option>
            <option>Last 6 months</option>
            <option>Last 3 months</option>
            <option>Year to date</option>
            <option>Custom range</option>
        </select>
        
        <h2 class="section-title" style="margin-bottom: 0;">Financial Analytics</h2>
    </div>
    
    <button style="
        background-color: #22c55e;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        font-weight: 500;
        cursor: pointer;
        transition: background-color 0.2s ease;
    " onmouseover="this.style.backgroundColor='#16a34a'" onmouseout="this.style.backgroundColor='#22c55e'">
        Export Report
    </button>
</div>

<!-- Key Metrics Overview -->
<div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); margin-bottom: 32px;">
    <div class="card">
        <h3>Average Monthly Income</h3>
        <div class="metric-value metric-positive">‚Ç∫3,185.50</div>
        <p style="color: #22c55e; font-size: 12px; margin-top: 4px;">‚Üó +5.2% vs last period</p>
    </div>
    
    <div class="card">
        <h3>Average Monthly Expenses</h3>
        <div class="metric-value metric-negative">‚Ç∫2,640.20</div>
        <p style="color: #ef4444; font-size: 12px; margin-top: 4px;">‚Üó +8.1% vs last period</p>
    </div>
    
    <div class="card">
        <h3>Net Savings Rate</h3>
        <div class="metric-value metric-neutral">17.1%</div>
        <p style="color: #a1a1aa; font-size: 12px; margin-top: 4px;">‚Üò -2.9% vs last period</p>
    </div>
    
    <div class="card">
        <h3>Financial Health Score</h3>
        <div class="metric-value metric-positive">8.2/10</div>
        <p style="color: #22c55e; font-size: 12px; margin-top: 4px;">Excellent</p>
    </div>
</div>

<!-- Charts Section -->
<div style="display: grid; grid-template-columns: 2fr 1fr; gap: 24px; margin-bottom: 32px;">
    <!-- Income vs Expenses Trend -->
    <div class="card">
        <h3 class="section-title">Income vs Expenses Trend</h3>
        <div style="height: 300px; position: relative;">
            <!-- Line Chart Container -->
            <canvas id="incomeExpensesChart" width="800" height="260" style="width: 100%; height: 260px;"></canvas>
            
            <!-- Legend positioned higher in top-right corner -->
            <div style="
                position: absolute;
                top: 4px;
                right: 16px;
                background-color: rgba(0, 0, 0, 0.6);
                backdrop-filter: blur(8px);
                padding: 12px 16px;
                border-radius: 8px;
                border: 1px solid #27272a;
            ">
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                    <div style="width: 16px; height: 3px; background-color: #22c55e; border-radius: 1px;"></div>
                    <span style="color: #fafafa; font-size: 12px; font-weight: 500;">Income</span>
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <div style="width: 16px; height: 3px; background-color: #ef4444; border-radius: 1px;"></div>
                    <span style="color: #fafafa; font-size: 12px; font-weight: 500;">Expenses</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Spending by Category -->
    <div class="card">
        <h3 class="section-title">Spending by Category</h3>
        <div style="height: 300px; display: flex; align-items: center; justify-content: center; position: relative;">
            <!-- Pie Chart Container -->
            <canvas id="analyticsSpendingChart" width="200" height="200"></canvas>
            
            <!-- Legend positioned higher in top-right corner -->
            <div style="
                position: absolute;
                top: 4px;
                right: 16px;
                background-color: rgba(0, 0, 0, 0.6);
                backdrop-filter: blur(8px);
                padding: 16px;
                border-radius: 8px;
                border: 1px solid #27272a;
            ">
                <div style="margin-bottom: 10px;">
                    <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 3px;">
                        <div style="width: 10px; height: 10px; background-color: #ef4444; border-radius: 2px; flex-shrink: 0;"></div>
                        <span style="color: #fafafa; font-size: 11px; font-weight: 500;">Food</span>
                    </div>
                    <p style="color: #71717a; font-size: 10px; margin-left: 16px;">35% ‚Ä¢ ‚Ç∫420</p>
                </div>
                
                <div style="margin-bottom: 10px;">
                    <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 3px;">
                        <div style="width: 10px; height: 10px; background-color: #f59e0b; border-radius: 2px; flex-shrink: 0;"></div>
                        <span style="color: #fafafa; font-size: 11px; font-weight: 500;">Shopping</span>
                    </div>
                    <p style="color: #71717a; font-size: 10px; margin-left: 16px;">25% ‚Ä¢ ‚Ç∫300</p>
                </div>
                
                <div style="margin-bottom: 10px;">
                    <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 3px;">
                        <div style="width: 10px; height: 10px; background-color: #3b82f6; border-radius: 2px; flex-shrink: 0;"></div>
                        <span style="color: #fafafa; font-size: 11px; font-weight: 500;">Transport</span>
                    </div>
                    <p style="color: #71717a; font-size: 10px; margin-left: 16px;">20% ‚Ä¢ ‚Ç∫240</p>
                </div>
                
                <div style="margin-bottom: 10px;">
                    <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 3px;">
                        <div style="width: 10px; height: 10px; background-color: #8b5cf6; border-radius: 2px; flex-shrink: 0;"></div>
                        <span style="color: #fafafa; font-size: 11px; font-weight: 500;">Bills</span>
                    </div>
                    <p style="color: #71717a; font-size: 10px; margin-left: 16px;">15% ‚Ä¢ ‚Ç∫180</p>
                </div>
                
                <div>
                    <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 3px;">
                        <div style="width: 10px; height: 10px; background-color: #22c55e; border-radius: 2px; flex-shrink: 0;"></div>
                        <span style="color: #fafafa; font-size: 11px; font-weight: 500;">Entertainment</span>
                    </div>
                    <p style="color: #71717a; font-size: 10px; margin-left: 16px;">5% ‚Ä¢ ‚Ç∫60</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Insights & Recommendations -->
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 32px;">
    <!-- Financial Insights -->
    <div class="card">
        <h3 class="section-title">AI Insights</h3>
        
        <div style="margin-bottom: 20px; padding: 16px; background-color: #0f0f0f; border-left: 4px solid #22c55e; border-radius: 6px;">
            <h4 style="color: #22c55e; font-size: 14px; margin-bottom: 8px;">üí° Positive Trend</h4>
            <p style="color: #e4e4e7; font-size: 13px; line-height: 1.5;">Your savings rate has improved by 12% over the last quarter. You're consistently saving more than your target.</p>
        </div>
        
        <div style="margin-bottom: 20px; padding: 16px; background-color: #0f0f0f; border-left: 4px solid #f59e0b; border-radius: 6px;">
            <h4 style="color: #f59e0b; font-size: 14px; margin-bottom: 8px;">‚ö†Ô∏è Watch Out</h4>
            <p style="color: #e4e4e7; font-size: 13px; line-height: 1.5;">Your shopping expenses increased by 40% this month. Consider reviewing discretionary purchases.</p>
        </div>
        
        <div style="padding: 16px; background-color: #0f0f0f; border-left: 4px solid #3b82f6; border-radius: 6px;">
            <h4 style="color: #3b82f6; font-size: 14px; margin-bottom: 8px;">üìä Pattern Detected</h4>
            <p style="color: #e4e4e7; font-size: 13px; line-height: 1.5;">You spend 23% more on weekends compared to weekdays. Plan your weekend activities in advance.</p>
        </div>
    </div>
    
    <!-- Recommendations -->
    <div class="card">
        <h3 class="section-title">Smart Recommendations</h3>
        
        <div style="margin-bottom: 20px; padding: 16px; background-color: #0f0f0f; border: 1px solid #27272a; border-radius: 8px;">
            <h4 style="color: #fafafa; font-size: 14px; margin-bottom: 8px;">üéØ Optimize Savings</h4>
            <p style="color: #a1a1aa; font-size: 13px; margin-bottom: 8px;">Based on your spending patterns, you could save an additional ‚Ç∫180/month by:</p>
            <ul style="color: #71717a; font-size: 12px; margin-left: 16px;">
                <li>Reducing dining out by 2 times per week</li>
                <li>Using public transport instead of ride-sharing</li>
            </ul>
        </div>
        
        <div style="margin-bottom: 20px; padding: 16px; background-color: #0f0f0f; border: 1px solid #27272a; border-radius: 8px;">
            <h4 style="color: #fafafa; font-size: 14px; margin-bottom: 8px;">üí≥ Better Credit Utilization</h4>
            <p style="color: #a1a1aa; font-size: 13px; margin-bottom: 8px;">Your credit utilization is optimal at 25.7%. To improve your credit score:</p>
            <ul style="color: #71717a; font-size: 12px; margin-left: 16px;">
                <li>Keep utilization below 30%</li>
                <li>Consider paying balances twice per month</li>
            </ul>
        </div>
        
        <div style="padding: 16px; background-color: #0f0f0f; border: 1px solid #27272a; border-radius: 8px;">
            <h4 style="color: #fafafa; font-size: 14px; margin-bottom: 8px;">üìà Investment Opportunity</h4>
            <p style="color: #a1a1aa; font-size: 13px; margin-bottom: 8px;">You have ‚Ç∫800+ monthly surplus. Consider:</p>
            <ul style="color: #71717a; font-size: 12px; margin-left: 16px;">
                <li>ISA contributions for tax efficiency</li>
                <li>Diversified index fund investments</li>
            </ul>
        </div>
    </div>
</div>

<!-- Account Performance -->
<div class="card">
    <h3 class="section-title">Account Performance</h3>
    
    <div style="overflow-x: auto;">
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="border-bottom: 1px solid #27272a;">
                    <th style="text-align: left; padding: 12px 0; color: #a1a1aa; font-size: 12px; text-transform: uppercase;">Account</th>
                    <th style="text-align: right; padding: 12px 0; color: #a1a1aa; font-size: 12px; text-transform: uppercase;">Balance Change</th>
                    <th style="text-align: right; padding: 12px 0; color: #a1a1aa; font-size: 12px; text-transform: uppercase;">Transactions</th>
                    <th style="text-align: right; padding: 12px 0; color: #a1a1aa; font-size: 12px; text-transform: uppercase;">Avg. Transaction</th>
                    <th style="text-align: right; padding: 12px 0; color: #a1a1aa; font-size: 12px; text-transform: uppercase;">Status</th>
                </tr>
            </thead>
            <tbody>
                <tr style="border-bottom: 1px solid #27272a;">
                    <td style="padding: 16px 0; color: #fafafa;">Akbank Business Current</td>
                    <td style="padding: 16px 0; text-align: right; color: #22c55e; font-weight: 600;">+‚Ç∫1,250.80</td>
                    <td style="padding: 16px 0; text-align: right; color: #e4e4e7;">47</td>
                    <td style="padding: 16px 0; text-align: right; color: #e4e4e7;">‚Ç∫142.30</td>
                    <td style="padding: 16px 0; text-align: right;">
                        <span style="background-color: #22c55e20; color: #22c55e; padding: 4px 8px; border-radius: 4px; font-size: 11px;">Active</span>
                    </td>
                </tr>
                <tr style="border-bottom: 1px solid #27272a;">
                    <td style="padding: 16px 0; color: #fafafa;">Garanti BBVA Savings</td>
                    <td style="padding: 16px 0; text-align: right; color: #22c55e; font-weight: 600;">+‚Ç∫590.25</td>
                    <td style="padding: 16px 0; text-align: right; color: #e4e4e7;">8</td>
                    <td style="padding: 16px 0; text-align: right; color: #e4e4e7;">‚Ç∫73.78</td>
                    <td style="padding: 16px 0; text-align: right;">
                        <span style="background-color: #22c55e20; color: #22c55e; padding: 4px 8px; border-radius: 4px; font-size: 11px;">Active</span>
                    </td>
                </tr>
                <tr>
                    <td style="padding: 16px 0; color: #fafafa;">ƒ∞≈ü Bankasƒ± Credit Card</td>
                    <td style="padding: 16px 0; text-align: right; color: #ef4444; font-weight: 600;">-‚Ç∫284.50</td>
                    <td style="padding: 16px 0; text-align: right; color: #e4e4e7;">23</td>
                    <td style="padding: 16px 0; text-align: right; color: #e4e4e7;">‚Ç∫55.87</td>
                    <td style="padding: 16px 0; text-align: right;">
                        <span style="background-color: #ef444420; color: #ef4444; padding: 4px 8px; border-radius: 4px; font-size: 11px;">Credit</span>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<script>
// Hardcoded data for line chart - will be pulled from DB later
const chartData = {
    labels: ['Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec', 'Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
    income: [3200, 3100, 3350, 3250, 3400, 3180, 3450, 3300, 3520, 3280, 3150, 3380],
    expenses: [2450, 2680, 2320, 2750, 2580, 2890, 2420, 2650, 2380, 2720, 2560, 2640]
};

function drawLineChart(canvasId, data) {
    const canvas = document.getElementById(canvasId);
    const ctx = canvas.getContext('2d');
    const padding = 60;
    const chartWidth = canvas.width - (padding * 2);
    const chartHeight = canvas.height - (padding * 2);
    
    // Create tooltip element
    let tooltip = document.getElementById('chart-tooltip');
    if (!tooltip) {
        tooltip = document.createElement('div');
        tooltip.id = 'chart-tooltip';
        tooltip.style.cssText = `
            position: absolute;
            background-color: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 12px;
            pointer-events: none;
            z-index: 1000;
            border: 1px solid #27272a;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(8px);
            display: none;
            min-width: 160px;
        `;
        document.body.appendChild(tooltip);
    }
    
    // Find min and max values for scaling
    const allValues = [...data.income, ...data.expenses];
    const minValue = Math.min(...allValues) - 200;
    const maxValue = Math.max(...allValues) + 200;
    const valueRange = maxValue - minValue;
    
    // Helper function to scale values
    function scaleX(index) {
        return padding + (index / (data.labels.length - 1)) * chartWidth;
    }
    
    function scaleY(value) {
        return padding + chartHeight - ((value - minValue) / valueRange) * chartHeight;
    }
    
    // Store data points for hover detection
    const dataPoints = {
        income: [],
        expenses: []
    };
    
    // Function to draw the base chart (without highlighting)
    function drawBaseChart() {
        // Clear canvas
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // Draw grid lines
        ctx.strokeStyle = '#27272a';
        ctx.lineWidth = 1;
        
        // Horizontal grid lines
        for (let i = 0; i <= 5; i++) {
            const y = padding + (i / 5) * chartHeight;
            ctx.beginPath();
            ctx.moveTo(padding, y);
            ctx.lineTo(padding + chartWidth, y);
            ctx.stroke();
        }
        
        // Vertical grid lines
        for (let i = 0; i < data.labels.length; i++) {
            const x = scaleX(i);
            ctx.beginPath();
            ctx.moveTo(x, padding);
            ctx.lineTo(x, padding + chartHeight);
            ctx.stroke();
        }
        
        // Draw Y-axis labels
        ctx.fillStyle = '#71717a';
        ctx.font = '12px system-ui';
        ctx.textAlign = 'right';
        ctx.textBaseline = 'middle';
        
        for (let i = 0; i <= 5; i++) {
            const value = minValue + (i / 5) * valueRange;
            const y = padding + chartHeight - (i / 5) * chartHeight;
            ctx.fillText(`‚Ç∫${Math.round(value)}`, padding - 10, y);
        }
        
        // Draw X-axis labels
        ctx.textAlign = 'center';
        ctx.textBaseline = 'top';
        
        for (let i = 0; i < data.labels.length; i++) {
            const x = scaleX(i);
            ctx.fillText(data.labels[i], x, padding + chartHeight + 10);
        }
        
        // Draw income line (green)
        ctx.strokeStyle = '#22c55e';
        ctx.lineWidth = 3;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        
        ctx.beginPath();
        for (let i = 0; i < data.income.length; i++) {
            const x = scaleX(i);
            const y = scaleY(data.income[i]);
            
            if (i === 0) {
                ctx.moveTo(x, y);
            } else {
                ctx.lineTo(x, y);
            }
        }
        ctx.stroke();
        
        // Draw income data points
        ctx.fillStyle = '#22c55e';
        for (let i = 0; i < data.income.length; i++) {
            const x = scaleX(i);
            const y = scaleY(data.income[i]);
            
            ctx.beginPath();
            ctx.arc(x, y, 4, 0, 2 * Math.PI);
            ctx.fill();
        }
        
        // Draw expenses line (red)
        ctx.strokeStyle = '#ef4444';
        ctx.lineWidth = 3;
        
        ctx.beginPath();
        for (let i = 0; i < data.expenses.length; i++) {
            const x = scaleX(i);
            const y = scaleY(data.expenses[i]);
            
            if (i === 0) {
                ctx.moveTo(x, y);
            } else {
                ctx.lineTo(x, y);
            }
        }
        ctx.stroke();
        
        // Draw expenses data points
        ctx.fillStyle = '#ef4444';
        for (let i = 0; i < data.expenses.length; i++) {
            const x = scaleX(i);
            const y = scaleY(data.expenses[i]);
            
            ctx.beginPath();
            ctx.arc(x, y, 4, 0, 2 * Math.PI);
            ctx.fill();
        }
    }
    
    // Initial chart draw and data point storage
    drawBaseChart();
    
    // Store data points for hover detection
    for (let i = 0; i < data.income.length; i++) {
        const x = scaleX(i);
        const yIncome = scaleY(data.income[i]);
        const yExpenses = scaleY(data.expenses[i]);
        
        dataPoints.income.push({ x, y: yIncome, value: data.income[i], month: data.labels[i], index: i });
        dataPoints.expenses.push({ x, y: yExpenses, value: data.expenses[i], month: data.labels[i], index: i });
    }
    
    let currentHighlightedPoint = null;
    let currentHighlightedType = null;
    
    // Throttle mousemove events for better performance
    let isThrottled = false;
    
    // Enhanced hover effect with tooltip
    canvas.addEventListener('mousemove', function(e) {
        if (isThrottled) return;
        isThrottled = true;
        
        setTimeout(() => {
            isThrottled = false;
        }, 16); // ~60fps
        
        const rect = canvas.getBoundingClientRect();
        const mouseX = e.clientX - rect.left;
        const mouseY = e.clientY - rect.top;
        
        // Scale mouse coordinates to canvas coordinates
        const canvasMouseX = (mouseX / rect.width) * canvas.width;
        const canvasMouseY = (mouseY / rect.height) * canvas.height;
        
        let hoveredPoint = null;
        let hoveredType = null;
        const hoverRadius = 15;
        
        // Check income points
        for (const point of dataPoints.income) {
            const distance = Math.sqrt(
                Math.pow(canvasMouseX - point.x, 2) + Math.pow(canvasMouseY - point.y, 2)
            );
            if (distance <= hoverRadius) {
                hoveredPoint = point;
                hoveredType = 'income';
                break;
            }
        }
        
        // Check expenses points if no income point is hovered
        if (!hoveredPoint) {
            for (const point of dataPoints.expenses) {
                const distance = Math.sqrt(
                    Math.pow(canvasMouseX - point.x, 2) + Math.pow(canvasMouseY - point.y, 2)
                );
                if (distance <= hoverRadius) {
                    hoveredPoint = point;
                    hoveredType = 'expenses';
                    break;
                }
            }
        }
        
        // Only redraw if the hovered point changed
        if (hoveredPoint !== currentHighlightedPoint || hoveredType !== currentHighlightedType) {
            currentHighlightedPoint = hoveredPoint;
            currentHighlightedType = hoveredType;
            
            if (hoveredPoint) {
                canvas.style.cursor = 'pointer';
                
                // Calculate savings/deficit
                const monthIncome = data.income[hoveredPoint.index];
                const monthExpenses = data.expenses[hoveredPoint.index];
                const savings = monthIncome - monthExpenses;
                const savingsRate = ((savings / monthIncome) * 100).toFixed(1);
                
                // Show detailed tooltip
                tooltip.innerHTML = `
                    <div style="font-weight: 600; margin-bottom: 8px; color: #fafafa;">
                        ${hoveredPoint.month} 2024
                    </div>
                    <div style="margin-bottom: 4px;">
                        <span style="color: #22c55e;">‚óè Income:</span> ‚Ç∫${monthIncome.toLocaleString()}
                    </div>
                    <div style="margin-bottom: 4px;">
                        <span style="color: #ef4444;">‚óè Expenses:</span> ‚Ç∫${monthExpenses.toLocaleString()}
                    </div>
                    <div style="margin-bottom: 4px; padding-top: 4px; border-top: 1px solid #27272a;">
                        <span style="color: ${savings >= 0 ? '#22c55e' : '#ef4444'};">
                            ${savings >= 0 ? 'Savings' : 'Deficit'}: ‚Ç∫${Math.abs(savings).toLocaleString()}
                        </span>
                    </div>
                    <div style="color: #a1a1aa; font-size: 11px;">
                        Savings Rate: ${savingsRate}%
                    </div>
                `;
                
                // Position tooltip
                const tooltipX = e.clientX + 10;
                const tooltipY = e.clientY - 10;
                
                tooltip.style.left = tooltipX + 'px';
                tooltip.style.top = tooltipY + 'px';
                tooltip.style.display = 'block';
                
                // Redraw base chart and highlight point
                drawBaseChart();
                
                // Highlight the hovered point
                ctx.save();
                ctx.shadowColor = hoveredType === 'income' ? '#22c55e' : '#ef4444';
                ctx.shadowBlur = 10;
                ctx.fillStyle = hoveredType === 'income' ? '#22c55e' : '#ef4444';
                ctx.beginPath();
                ctx.arc(hoveredPoint.x, hoveredPoint.y, 6, 0, 2 * Math.PI);
                ctx.fill();
                
                // Add white border to highlighted point
                ctx.strokeStyle = '#ffffff';
                ctx.lineWidth = 2;
                ctx.stroke();
                ctx.restore();
                
            } else {
                canvas.style.cursor = 'default';
                tooltip.style.display = 'none';
                
                // Redraw base chart without highlighting
                drawBaseChart();
            }
        }
    });
    
    // Hide tooltip when mouse leaves canvas
    canvas.addEventListener('mouseleave', function() {
        tooltip.style.display = 'none';
        canvas.style.cursor = 'default';
        currentHighlightedPoint = null;
        currentHighlightedType = null;
        drawBaseChart(); // Remove highlighting
    });
}

// Update the existing analytics pie chart data and function calls
const analyticsSpendingData = [
    { label: 'Food & Dining', value: 420, percentage: 35, color: '#ef4444' },
    { label: 'Shopping', value: 300, percentage: 25, color: '#f59e0b' },
    { label: 'Transportation', value: 240, percentage: 20, color: '#3b82f6' },
    { label: 'Bills & Utilities', value: 180, percentage: 15, color: '#8b5cf6' },
    { label: 'Entertainment', value: 60, percentage: 5, color: '#22c55e' }
];

function drawPieChart(canvasId, data) {
    const canvas = document.getElementById(canvasId);
    const ctx = canvas.getContext('2d');
    const centerX = canvas.width / 2;
    const centerY = canvas.height / 2;
    const radius = 90;
    
    let currentAngle = -Math.PI / 2; // Start from top
    
    // Clear canvas
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    data.forEach(item => {
        const sliceAngle = (item.percentage / 100) * 2 * Math.PI;
        
        // Draw slice
        ctx.beginPath();
        ctx.moveTo(centerX, centerY);
        ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
        ctx.closePath();
        ctx.fillStyle = item.color;
        ctx.fill();
        
        // Add border
        ctx.strokeStyle = '#111111';
        ctx.lineWidth = 2;
        ctx.stroke();
        
        currentAngle += sliceAngle;
    });
}

// Draw charts when page loads
document.addEventListener('DOMContentLoaded', function() {
    drawPieChart('analyticsSpendingChart', analyticsSpendingData);
    drawLineChart('incomeExpensesChart', chartData);
});
</script>
{% endblock %}