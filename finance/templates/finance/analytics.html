{% extends 'base.html' %}

{% block page_title %}Analytics{% endblock %}

{% block content %}
<!-- Header with time period selector -->
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px;">
    <div style="display: flex; gap: 16px; align-items: center;">
        <form method="GET" id="analyticsFilterForm">
            <select name="period" onchange="submitAnalyticsFilter()" style="
                background-color: #111111;
                border: 1px solid #27272a;
                color: #e4e4e7;
                padding: 8px 12px;
                border-radius: 6px;
                font-size: 14px;
            ">
                <option value="12" {% if request.GET.period == "12" or not request.GET.period %}selected{% endif %}>Last 12 months</option>
                <option value="6" {% if request.GET.period == "6" %}selected{% endif %}>Last 6 months</option>
                <option value="3" {% if request.GET.period == "3" %}selected{% endif %}>Last 3 months</option>
                <option value="ytd" {% if request.GET.period == "ytd" %}selected{% endif %}>Year to date</option>
                <option value="all" {% if request.GET.period == "all" %}selected{% endif %}>All time</option>
            </select>
        </form>
        
        <h2 class="section-title" style="margin-bottom: 0;">Financial Analytics</h2>
    </div>
    
    <button onclick="exportAnalyticsReport()" style="
        background-color: #22c55e;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        font-weight: 500;
        cursor: pointer;
        transition: background-color 0.2s ease;
    " onmouseover="this.style.backgroundColor='#16a34a'" onmouseout="this.style.backgroundColor='#22c55e'">
        Export Report
    </button>
</div>

<!-- Key Metrics Grid - NOW RESPONDS TO FILTER -->
<div class="grid" style="margin-bottom: 32px;">
    <div class="card">
        <h3>{{ period_label }} Spending</h3>
        <div class="metric-value metric-negative">₺{{ current_spending|floatformat:2 }}</div>
        <p style="color: {% if spending_change < 0 %}#22c55e{% else %}#ef4444{% endif %}; font-size: 12px; margin-top: 4px;">
            {% if spending_change >= 0 %}↗ +{% else %}↘ {% endif %}{{ spending_change|floatformat:1 }}% vs previous period
        </p>
    </div>
    
    <div class="card">
        <h3>Average Monthly</h3>
        <div class="metric-value metric-neutral">₺{{ avg_monthly_spending|floatformat:2 }}</div>
        <p style="color: #a1a1aa; font-size: 12px; margin-top: 4px;">Based on {{ months_count }} month{{ months_count|pluralize }}</p>
    </div>
    
    <div class="card">
        <h3>Total Transactions</h3>
        <div class="metric-value metric-neutral">{{ total_transactions }}</div>
        <p style="color: #a1a1aa; font-size: 12px; margin-top: 4px;">{{ period_label|lower }}</p>
    </div>
    
    <div class="card">
        <h3>Net Change</h3>
        <div class="metric-value {% if net_change >= 0 %}metric-positive{% else %}metric-negative{% endif %}">
            {% if net_change >= 0 %}+{% endif %}₺{{ net_change|floatformat:2 }}
        </div>
        <p style="color: #a1a1aa; font-size: 12px; margin-top: 4px;">Income - Expenses</p>
    </div>
</div>

<!-- Charts Section -->
<div style="display: grid; grid-template-columns: 2fr 1fr; gap: 24px; margin-bottom: 32px;">
    <!-- Monthly Spending Trend -->
    <div class="card">
        <h3 class="section-title">Monthly Spending Trend</h3>
        <div style="height: 300px; position: relative;">
            <canvas id="monthlyTrendChart" width="800" height="260" style="width: 100%; height: 260px;"></canvas>
        </div>
    </div>
    
    <!-- Top Merchants -->
    <div class="card">
        <h3 class="section-title">Top Merchants</h3>
        <div style="height: 300px; overflow: hidden; position: relative;" id="merchantsContainer">
            <div id="merchantsList">
                {% for merchant in top_merchants %}
                <div style="margin-bottom: 16px; padding: 12px; background-color: #0f0f0f; border-radius: 8px;" 
                     class="merchant-item {% if forloop.counter > 3 %}hidden-merchant{% endif %}">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                        <p style="color: #fafafa; font-size: 14px; font-weight: 500;">{{ merchant.name }}</p>
                        <p style="color: #ef4444; font-size: 14px; font-weight: 600;">₺{{ merchant.total|floatformat:2 }}</p>
                    </div>
                    <p style="color: #71717a; font-size: 12px;">{{ merchant.count }} transaction{{ merchant.count|pluralize }}</p>
                </div>
                {% empty %}
                <p style="color: #71717a; text-align: center; margin-top: 40px;">No merchant data available</p>
                {% endfor %}
            </div>
            
            {% if top_merchants|length > 3 %}
            <!-- Gradient overlay for fade effect when collapsed -->
            <div id="fadeOverlay" style="
                position: absolute;
                bottom: 60px;
                left: 0;
                right: 0;
                height: 40px;
                background: linear-gradient(transparent, #111111);
                pointer-events: none;
            "></div>
            
            <!-- Expand/Collapse Button -->
            <div style="
                position: absolute;
                bottom: 0;
                left: 0;
                right: 0;
                background-color: #111111;
                padding: 12px 0;
                text-align: center;
                border-top: 1px solid #27272a;
            ">
                <button id="toggleMerchants" onclick="toggleMerchantsList()" style="
                    background: none;
                    border: none;
                    color: #22c55e;
                    font-size: 12px;
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    width: 100%;
                    gap: 4px;
                ">
                    <span id="toggleText">Show More</span>
                    <span id="toggleIcon" style="transition: transform 0.2s ease;">▼</span>
                </button>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Category Analysis -->
<div class="card" style="margin-bottom: 32px;">
    <h3 class="section-title">Spending by Category</h3>
    
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">
        {% for category in category_trends %}
        <div style="padding: 16px; background-color: #0f0f0f; border-radius: 8px; border: 1px solid #27272a;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <h4 style="color: #fafafa; font-size: 16px; font-weight: 600;">{{ category.label }}</h4>
                <p style="color: #ef4444; font-size: 18px; font-weight: 600;">₺{{ category.total|floatformat:2 }}</p>
            </div>
            
            <div style="margin-bottom: 8px;">
                <p style="color: #a1a1aa; font-size: 12px;">{{ category.count }} transactions</p>
                <p style="color: #71717a; font-size: 12px;">Avg: ₺{{ category.avg_transaction|floatformat:2 }} per transaction</p>
            </div>
        </div>
        {% empty %}
        <p style="color: #71717a; text-align: center; grid-column: 1 / -1;">No category data available</p>
        {% endfor %}
    </div>
</div>

<!-- Account Performance -->
<div class="card">
    <h3 class="section-title">Account Performance</h3>
    
    <div style="overflow-x: auto;">
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="border-bottom: 1px solid #27272a;">
                    <th style="text-align: left; padding: 12px 0; color: #a1a1aa; font-size: 12px; text-transform: uppercase;">Account</th>
                    <th style="text-align: right; padding: 12px 0; color: #a1a1aa; font-size: 12px; text-transform: uppercase;">Balance</th>
                    <th style="text-align: right; padding: 12px 0; color: #a1a1aa; font-size: 12px; text-transform: uppercase;">Monthly Inflow</th>
                    <th style="text-align: right; padding: 12px 0; color: #a1a1aa; font-size: 12px; text-transform: uppercase;">Monthly Outflow</th>
                    <th style="text-align: right; padding: 12px 0; color: #a1a1aa; font-size: 12px; text-transform: uppercase;">Net Change</th>
                </tr>
            </thead>
            <tbody>
                {% for account in account_performance %}
                <tr style="border-bottom: 1px solid #27272a;">
                    <td style="padding: 16px 0; color: #fafafa;">{{ account.name }}</td>
                    <td style="padding: 16px 0; text-align: right; color: {% if account.balance >= 0 %}#22c55e{% else %}#ef4444{% endif %}; font-weight: 600;">
                        ₺{{ account.balance|floatformat:2 }}
                    </td>
                    <td style="padding: 16px 0; text-align: right; color: #22c55e;">₺{{ account.inflow|floatformat:2 }}</td>
                    <td style="padding: 16px 0; text-align: right; color: #ef4444;">₺{{ account.outflow|floatformat:2 }}</td>
                    <td style="padding: 16px 0; text-align: right; color: {% if account.net_change >= 0 %}#22c55e{% else %}#ef4444{% endif %}; font-weight: 600;">
                        {% if account.net_change >= 0 %}+{% endif %}₺{{ account.net_change|floatformat:2 }}
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5" style="padding: 20px; text-align: center; color: #71717a;">No account data available</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
// USE REAL DATA FROM VIEWS
const realMonthlyTrends = {{ monthly_trends|safe }};
const realDailySpending = {{ daily_spending|safe }};

// Filter functionality
function submitAnalyticsFilter() {
    document.getElementById('analyticsFilterForm').submit();
}

function exportAnalyticsReport() {
    // Get current filter parameters
    const form = document.getElementById('analyticsFilterForm');
    const formData = new FormData(form);
    const params = new URLSearchParams(formData);
    
    // Add export parameter
    params.append('export', 'report');
    
    // Create download link
    const url = window.location.pathname + '?' + params.toString();
    window.location.href = url;
}

// Add this right after the realMonthlyTrends declaration for debugging
console.log('Monthly trends data structure:', realMonthlyTrends);

function drawMonthlyTrendChart() {
    const canvas = document.getElementById('monthlyTrendChart');
    if (!canvas) return;
    
    const ctx = canvas.getContext('2d');
    const padding = 60;
    const chartWidth = canvas.width - (padding * 2);
    const chartHeight = canvas.height - (padding * 2);
    
    if (realMonthlyTrends.length === 0) {
        ctx.fillStyle = '#71717a';
        ctx.font = '16px system-ui';
        ctx.textAlign = 'center';
        ctx.fillText('No data available', canvas.width / 2, canvas.height / 2);
        return;
    }
    
    // Find min and max values for scaling
    const values = realMonthlyTrends.map(item => item.spending);
    const minValue = Math.min(...values) - 100;
    const maxValue = Math.max(...values) + 100;
    const valueRange = maxValue - minValue;
    
    // Store data points for tooltip interaction
    const dataPoints = [];
    
    // Helper functions
    function scaleX(index) {
        return padding + (index / (realMonthlyTrends.length - 1)) * chartWidth;
    }
    
    function scaleY(value) {
        return padding + chartHeight - ((value - minValue) / valueRange) * chartHeight;
    }
    
    // Clear canvas
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // Draw grid lines
    ctx.strokeStyle = '#27272a';
    ctx.lineWidth = 1;
    
    // Horizontal grid lines
    for (let i = 0; i <= 5; i++) {
        const y = padding + (i / 5) * chartHeight;
        ctx.beginPath();
        ctx.moveTo(padding, y);
        ctx.lineTo(padding + chartWidth, y);
        ctx.stroke();
    }
    
    // Vertical grid lines
    for (let i = 0; i < realMonthlyTrends.length; i++) {
        const x = scaleX(i);
        ctx.beginPath();
        ctx.moveTo(x, padding);
        ctx.lineTo(x, padding + chartHeight);
        ctx.stroke();
    }
    
    // Draw Y-axis labels
    ctx.fillStyle = '#71717a';
    ctx.font = '12px system-ui';
    ctx.textAlign = 'right';
    ctx.textBaseline = 'middle';
    
    for (let i = 0; i <= 5; i++) {
        const value = minValue + (i / 5) * valueRange;
        const y = padding + chartHeight - (i / 5) * chartHeight;
        ctx.fillText(`₺${Math.round(value)}`, padding - 10, y);
    }
    
    // Draw X-axis labels
    ctx.textAlign = 'center';
    ctx.textBaseline = 'top';
    
    for (let i = 0; i < realMonthlyTrends.length; i++) {
        const x = scaleX(i);
        ctx.fillText(realMonthlyTrends[i].month, x, padding + chartHeight + 10);
    }
    
    // Draw spending line
    ctx.strokeStyle = '#ef4444';
    ctx.lineWidth = 3;
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';
    
    ctx.beginPath();
    for (let i = 0; i < realMonthlyTrends.length; i++) {
        const x = scaleX(i);
        const y = scaleY(realMonthlyTrends[i].spending);
        
        if (i === 0) {
            ctx.moveTo(x, y);
        } else {
            ctx.lineTo(x, y);
        }
    }
    ctx.stroke();
    
    // Draw data points and store their positions
    ctx.fillStyle = '#ef4444';
    for (let i = 0; i < realMonthlyTrends.length; i++) {
        const x = scaleX(i);
        const y = scaleY(realMonthlyTrends[i].spending);
        
        // Store data point for tooltip
        dataPoints.push({
            x: x,
            y: y,
            data: realMonthlyTrends[i],
            index: i
        });
        
        ctx.beginPath();
        ctx.arc(x, y, 4, 0, 2 * Math.PI);
        ctx.fill();
    }
    
    // Add tooltip functionality
    let tooltip = document.getElementById('chartTooltip');
    if (!tooltip) {
        tooltip = document.createElement('div');
        tooltip.id = 'chartTooltip';
        tooltip.style.cssText = `
            position: absolute;
            background: #1a1a1a;
            border: 1px solid #27272a;
            border-radius: 6px;
            padding: 8px 12px;
            color: #fafafa;
            font-size: 12px;
            font-weight: 500;
            pointer-events: none;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            display: none;
            white-space: nowrap;
        `;
        document.body.appendChild(tooltip);
    }
    
    // Mouse event handlers
    function getMousePos(e) {
        const rect = canvas.getBoundingClientRect();
        const scaleX = canvas.width / rect.width;
        const scaleY = canvas.height / rect.height;
        return {
            x: (e.clientX - rect.left) * scaleX,
            y: (e.clientY - rect.top) * scaleY
        };
    }
    
    function findNearestPoint(mouseX, mouseY) {
        let nearestPoint = null;
        let minDistance = Infinity;
        
        for (const point of dataPoints) {
            const distance = Math.sqrt(
                Math.pow(mouseX - point.x, 2) + Math.pow(mouseY - point.y, 2)
            );
            
            if (distance < 15 && distance < minDistance) {
                minDistance = distance;
                nearestPoint = point;
            }
        }
        
        return nearestPoint;
    }
    
    canvas.addEventListener('mousemove', function(e) {
        const mousePos = getMousePos(e);
        const nearestPoint = findNearestPoint(mousePos.x, mousePos.y);
        
        if (nearestPoint) {
            // Show tooltip
            const rect = canvas.getBoundingClientRect();
            const tooltipX = rect.left + (nearestPoint.x / canvas.width) * rect.width;
            const tooltipY = rect.top + (nearestPoint.y / canvas.height) * rect.height;
            
            tooltip.innerHTML = `
                <div style="font-weight: 600; margin-bottom: 4px;">${nearestPoint.data.month}</div>
                <div style="color: #ef4444;">Spending: ₺${nearestPoint.data.spending.toFixed(2)}</div>
                <div style="color: #a1a1aa; margin-top: 2px;">${nearestPoint.data.transactions || nearestPoint.data.count || nearestPoint.data.transaction_count || 'N/A'} transactions</div>
            `;
            
            tooltip.style.left = (tooltipX + 10) + 'px';
            tooltip.style.top = (tooltipY - 50) + 'px';
            tooltip.style.display = 'block';
            
            // Change cursor
            canvas.style.cursor = 'pointer';
            
            // Highlight the point
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            drawChart(); // Redraw chart
            
            // Draw highlighted point
            ctx.fillStyle = '#fca311';
            ctx.beginPath();
            ctx.arc(nearestPoint.x, nearestPoint.y, 6, 0, 2 * Math.PI);
            ctx.fill();
            
            // Draw white border around highlighted point
            ctx.strokeStyle = '#fafafa';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.arc(nearestPoint.x, nearestPoint.y, 6, 0, 2 * Math.PI);
            ctx.stroke();
            
        } else {
            // Hide tooltip
            tooltip.style.display = 'none';
            canvas.style.cursor = 'default';
            
            // Redraw chart without highlight
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            drawChart();
        }
    });
    
    canvas.addEventListener('mouseleave', function() {
        tooltip.style.display = 'none';
        canvas.style.cursor = 'default';
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        drawChart();
    });
    
    // Helper function to redraw the chart (without highlights)
    function drawChart() {
        // Draw grid lines
        ctx.strokeStyle = '#27272a';
        ctx.lineWidth = 1;
        
        // Horizontal grid lines
        for (let i = 0; i <= 5; i++) {
            const y = padding + (i / 5) * chartHeight;
            ctx.beginPath();
            ctx.moveTo(padding, y);
            ctx.lineTo(padding + chartWidth, y);
            ctx.stroke();
        }
        
        // Vertical grid lines
        for (let i = 0; i < realMonthlyTrends.length; i++) {
            const x = scaleX(i);
            ctx.beginPath();
            ctx.moveTo(x, padding);
            ctx.lineTo(x, padding + chartHeight);
            ctx.stroke();
        }
        
        // Draw Y-axis labels
        ctx.fillStyle = '#71717a';
        ctx.font = '12px system-ui';
        ctx.textAlign = 'right';
        ctx.textBaseline = 'middle';
        
        for (let i = 0; i <= 5; i++) {
            const value = minValue + (i / 5) * valueRange;
            const y = padding + chartHeight - (i / 5) * chartHeight;
            ctx.fillText(`₺${Math.round(value)}`, padding - 10, y);
        }
        
        // Draw X-axis labels
        ctx.textAlign = 'center';
        ctx.textBaseline = 'top';
        
        for (let i = 0; i < realMonthlyTrends.length; i++) {
            const x = scaleX(i);
            ctx.fillText(realMonthlyTrends[i].month, x, padding + chartHeight + 10);
        }
        
        // Draw spending line
        ctx.strokeStyle = '#ef4444';
        ctx.lineWidth = 3;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        
        ctx.beginPath();
        for (let i = 0; i < realMonthlyTrends.length; i++) {
            const x = scaleX(i);
            const y = scaleY(realMonthlyTrends[i].spending);
            
            if (i === 0) {
                ctx.moveTo(x, y);
            } else {
                ctx.lineTo(x, y);
            }
        }
        ctx.stroke();
        
        // Draw data points
        ctx.fillStyle = '#ef4444';
        for (let i = 0; i < realMonthlyTrends.length; i++) {
            const x = scaleX(i);
            const y = scaleY(realMonthlyTrends[i].spending);
            
            ctx.beginPath();
            ctx.arc(x, y, 4, 0, 2 * Math.PI);
            ctx.fill();
        }
    }
}

// Draw chart when page loads
document.addEventListener('DOMContentLoaded', function() {
    drawMonthlyTrendChart();
});

// Add merchant list toggle functionality
let merchantsExpanded = false;

function toggleMerchantsList() {
    const hiddenMerchants = document.querySelectorAll('.hidden-merchant');
    const toggleText = document.getElementById('toggleText');
    const toggleIcon = document.getElementById('toggleIcon');
    const fadeOverlay = document.getElementById('fadeOverlay');
    const container = document.getElementById('merchantsContainer');
    
    merchantsExpanded = !merchantsExpanded;
    
    if (merchantsExpanded) {
        // Show all merchants
        hiddenMerchants.forEach(merchant => {
            merchant.style.display = 'block';
            merchant.style.animation = 'fadeIn 0.3s ease-in-out';
        });
        
        // Update button
        toggleText.textContent = 'Show Less';
        toggleIcon.style.transform = 'rotate(180deg)';
        toggleIcon.textContent = '▲';
        
        // Hide fade overlay
        if (fadeOverlay) {
            fadeOverlay.style.display = 'none';
        }
        
        // Expand container height
        container.style.height = 'auto';
        container.style.maxHeight = '500px';
        container.style.overflowY = 'auto';
        
    } else {
        // Hide extra merchants
        hiddenMerchants.forEach(merchant => {
            merchant.style.display = 'none';
        });
        
        // Update button
        toggleText.textContent = 'Show More';
        toggleIcon.style.transform = 'rotate(0deg)';
        toggleIcon.textContent = '▼';
        
        // Show fade overlay
        if (fadeOverlay) {
            fadeOverlay.style.display = 'block';
        }
        
        // Reset container height
        container.style.height = '300px';
        container.style.overflowY = 'hidden';
        
        // Scroll back to top of merchant list
        container.scrollTop = 0;
    }
}

// Add CSS animation for smooth appearance
const style = document.createElement('style');
style.textContent = `
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .hidden-merchant {
        display: none;
    }
    
    #merchantsContainer::-webkit-scrollbar {
        width: 6px;
    }
    
    #merchantsContainer::-webkit-scrollbar-track {
        background: #27272a;
        border-radius: 3px;
    }
    
    #merchantsContainer::-webkit-scrollbar-thumb {
        background: #52525b;
        border-radius: 3px;
    }
    
    #merchantsContainer::-webkit-scrollbar-thumb:hover {
        background: #71717a;
    }
`;
document.head.appendChild(style);

// Existing chart drawing code...
drawMonthlyTrendChart();
</script>
{% endblock %}