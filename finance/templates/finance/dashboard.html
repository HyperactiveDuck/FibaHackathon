{% extends 'base.html' %}

{% block page_title %}Dashboard{% endblock %}

{% block content %}
<!-- Welcome Section -->
<div style="margin-bottom: 32px;">
    <h2 style="color: #fafafa; font-size: 24px; font-weight: 600; margin-bottom: 8px;">Welcome back, {{ user_name }}!</h2>
    <p style="color: #71717a; font-size: 14px;">Here's your financial overview for today.</p>
</div>

<!-- Quick Stats Grid -->
<div class="grid" style="margin-bottom: 32px;">
    <div class="card">
        <h3>Total Balance</h3>
        <div class="metric-value metric-positive">‚Ç∫{{ total_balance|floatformat:2 }}</div>
        <p style="color: #22c55e; font-size: 12px; margin-top: 4px;">‚Üó +2.3% from last month</p>
    </div>
    
    <div class="card">
        <h3>Monthly Spending</h3>
        <div class="metric-value metric-negative">‚Ç∫{{ monthly_spending|floatformat:2 }}</div>
        <p style="color: #a1a1aa; font-size: 12px; margin-top: 4px;">Budget: ‚Ç∫{{ monthly_budget|floatformat:2 }}</p>
    </div>
    
    <div class="card">
        <h3>Savings This Month</h3>
        <div class="metric-value metric-neutral">‚Ç∫{{ savings_this_month|floatformat:2 }}</div>
        <p style="color: #22c55e; font-size: 12px; margin-top: 4px;">Goal: ‚Ç∫{{ savings_goal|floatformat:2 }} achieved</p>
    </div>
    
    <div class="card">
        <h3>Upcoming Bills</h3>
        <div class="metric-value metric-neutral">‚Ç∫{{ upcoming_bills|floatformat:2 }}</div>
        <p style="color: #f59e0b; font-size: 12px; margin-top: 4px;">3 bills due this week</p>
    </div>
</div>

<!-- Charts Section -->
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 32px;">
    <!-- Spending by Category Pie Chart -->
    <div class="card">
        <h3 class="section-title">Spending by Category</h3>
        <div style="height: 400px; display: flex; align-items: center; justify-content: center; position: relative;">
            <canvas id="spendingChart" width="280" height="280"></canvas>
            <div id="spendingLegend" style="
                position: absolute;
                top: 16px;
                right: 16px;
                background-color: rgba(0, 0, 0, 0.6);
                backdrop-filter: blur(8px);
                padding: 16px;
                border-radius: 8px;
                border: 1px solid #27272a;
            "></div>
        </div>
    </div>
    
    <!-- Account Distribution Pie Chart -->
    <div class="card">
        <h3 class="section-title">Account Distribution</h3>
        <div style="height: 400px; display: flex; align-items: center; justify-content: center; position: relative;">
            <canvas id="accountChart" width="280" height="280"></canvas>
            <div id="accountLegend" style="
                position: absolute;
                top: 16px;
                right: 16px;
                background-color: rgba(0, 0, 0, 0.6);
                backdrop-filter: blur(8px);
                padding: 16px;
                border-radius: 8px;
                border: 1px solid #27272a;
            "></div>
        </div>
    </div>
</div>

<!-- Recent Activity -->
<div style="display: grid; grid-template-columns: 2fr 1fr; gap: 24px; margin-bottom: 32px;">
    <!-- Recent Transactions -->
    <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3 class="section-title" style="margin-bottom: 0;">Recent Transactions</h3>
            <a href="{% url 'transactions' %}" style="color: #22c55e; text-decoration: none; font-size: 12px;">View All</a>
        </div>
        
        <div style="space-y: 12px;">
            {% for transaction in recent_transactions %}
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #27272a;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div style="width: 32px; height: 32px; background-color: {% if transaction.amount > 0 %}#22c55e20{% else %}#ef444420{% endif %}; border-radius: 6px; display: flex; align-items: center; justify-content: center;">
                        {% if transaction.category == 'FOOD_DINING' %}üçï
                        {% elif transaction.category == 'SALARY' %}üí∞
                        {% elif transaction.category == 'SHOPPING' %}üõí
                        {% elif transaction.category == 'BILLS_UTILITIES' %}‚ö°
                        {% elif transaction.category == 'TRANSPORTATION' %}üöá
                        {% elif transaction.category == 'ENTERTAINMENT' %}üé¨
                        {% else %}üí≥{% endif %}
                    </div>
                    <div>
                        <p style="color: #fafafa; font-size: 14px; margin-bottom: 2px;">{{ transaction.merchant|default:transaction.description }}</p>
                        <p style="color: #71717a; font-size: 11px;">{{ transaction.date|date:"M j, g:i A" }}</p>
                    </div>
                </div>
                <p style="color: {% if transaction.amount > 0 %}#22c55e{% else %}#ef4444{% endif %}; font-size: 14px; font-weight: 600;">
                    {% if transaction.amount > 0 %}+{% endif %}‚Ç∫{{ transaction.amount|floatformat:2 }}
                </p>
            </div>
            {% endfor %}
        </div>
    </div>
    
    <!-- Quick Actions -->
    <div class="card">
        <h3 class="section-title">Quick Actions</h3>
        
        <div style="display: flex; flex-direction: column; gap: 12px;">
            <button style="
                background-color: #27272a;
                color: #e4e4e7;
                border: none;
                padding: 12px 16px;
                border-radius: 8px;
                text-align: left;
                cursor: pointer;
                transition: background-color 0.2s ease;
                font-size: 14px;
            " onmouseover="this.style.backgroundColor='#3f3f46'" onmouseout="this.style.backgroundColor='#27272a'">
                üí≥ Connect New Account
            </button>
            
            <button style="
                background-color: #27272a;
                color: #e4e4e7;
                border: none;
                padding: 12px 16px;
                border-radius: 8px;
                text-align: left;
                cursor: pointer;
                transition: background-color 0.2s ease;
                font-size: 14px;
            " onmouseover="this.style.backgroundColor='#3f3f46'" onmouseout="this.style.backgroundColor='#27272a'">
                üéØ Set New Budget Goal
            </button>
            
            <button style="
                background-color: #27272a;
                color: #e4e4e7;
                border: none;
                padding: 12px 16px;
                border-radius: 8px;
                text-align: left;
                cursor: pointer;
                transition: background-color 0.2s ease;
                font-size: 14px;
            " onmouseover="this.style.backgroundColor='#3f3f46'" onmouseout="this.style.backgroundColor='#27272a'">
                üìä Generate Report
            </button>
            
            <button style="
                background-color: #27272a;
                color: #e4e4e7;
                border: none;
                padding: 12px 16px;
                border-radius: 8px;
                text-align: left;
                cursor: pointer;
                transition: background-color 0.2s ease;
                font-size: 14px;
            " onmouseover="this.style.backgroundColor='#3f3f46'" onmouseout="this.style.backgroundColor='#27272a'">
                ‚öôÔ∏è Manage Settings
            </button>
        </div>
    </div>
</div>

<!-- AI Chat Assistant -->
<div class="card" style="display: flex; flex-direction: column; height: 500px;">
    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid #27272a;">
        <div style="
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #22c55e, #3b82f6);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        ">ü§ñ</div>
        <h3 style="color: #fafafa; font-size: 16px; font-weight: 600; margin: 0;">AI Assistant</h3>
    </div>
    
    <!-- Chat Messages -->
    <div style="flex: 1; overflow-y: auto; margin-bottom: 16px;">
        <!-- AI Message -->
        <div style="margin-bottom: 16px;">
            <div style="
                background-color: #27272a;
                padding: 12px;
                border-radius: 12px 12px 12px 4px;
                margin-bottom: 4px;
            ">
                <p style="color: #e4e4e7; font-size: 13px; line-height: 1.4;">
                    Hi {{ user_name }}! I noticed you've spent ‚Ç∫{{ monthly_spending|floatformat:0 }} this month. Would you like some tips to optimize your spending?
                </p>
            </div>
            <p style="color: #71717a; font-size: 10px;">Just now</p>
        </div>
    </div>
    
    <!-- Chat Input -->
    <div style="display: flex; gap: 8px;">
        <input 
            type="text" 
            placeholder="Ask about your finances..."
            style="
                flex: 1;
                background-color: #0a0a0a;
                border: 1px solid #27272a;
                color: #e4e4e7;
                padding: 10px 12px;
                border-radius: 8px;
                font-size: 12px;
                outline: none;
            "
            onkeypress="if(event.key==='Enter') sendMessage(this)"
        />
        <button 
            onclick="sendMessage(this.previousElementSibling)"
            style="
                background-color: #22c55e;
                color: white;
                border: none;
                padding: 10px 12px;
                border-radius: 8px;
                cursor: pointer;
                font-size: 12px;
            ">
            Send
        </button>
    </div>
</div>

<script>
// Get data from Django context
const spendingData = {{ spending_categories|safe }};
const accountData = {{ account_distribution|safe }};

function drawPieChart(canvasId, data, legendId) {
    const canvas = document.getElementById(canvasId);
    const ctx = canvas.getContext('2d');
    const centerX = canvas.width / 2;
    const centerY = canvas.height / 2;
    const radius = 120;
    
    let currentAngle = -Math.PI / 2;
    
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    data.forEach(item => {
        const sliceAngle = (item.percentage / 100) * 2 * Math.PI;
        
        ctx.beginPath();
        ctx.moveTo(centerX, centerY);
        ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
        ctx.closePath();
        ctx.fillStyle = item.color;
        ctx.fill();
        
        ctx.strokeStyle = '#111111';
        ctx.lineWidth = 2;
        ctx.stroke();
        
        currentAngle += sliceAngle;
    });
    
    // Generate legend
    const legendContainer = document.getElementById(legendId);
    legendContainer.innerHTML = '';
    
    data.forEach(item => {
        const legendItem = document.createElement('div');
        legendItem.style.marginBottom = '10px';
        legendItem.innerHTML = `
            <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 3px;">
                <div style="width: 10px; height: 10px; background-color: ${item.color}; border-radius: 2px; flex-shrink: 0;"></div>
                <span style="color: #fafafa; font-size: 11px; font-weight: 500;">${item.label}</span>
            </div>
            <p style="color: #71717a; font-size: 10px; margin-left: 16px;">${item.percentage}% ‚Ä¢ ‚Ç∫${item.value.toFixed(0)}</p>
        `;
        legendContainer.appendChild(legendItem);
    });
}

function sendMessage(input) {
    const message = input.value.trim();
    if (!message) return;
    
    const chatContainer = input.closest('.card').querySelector('div[style*="flex: 1"]');
    const userMessage = `
        <div style="margin-bottom: 16px; text-align: right;">
            <div style="
                background-color: #22c55e;
                color: white;
                padding: 12px;
                border-radius: 12px 12px 4px 12px;
                margin-bottom: 4px;
                display: inline-block;
                max-width: 80%;
            ">
                <p style="font-size: 13px; line-height: 1.4;">${message}</p>
            </div>
            <p style="color: #71717a; font-size: 10px;">Just now</p>
        </div>
    `;
    
    chatContainer.innerHTML += userMessage;
    input.value = '';
    chatContainer.scrollTop = chatContainer.scrollHeight;
    
    setTimeout(() => {
        const responses = [
            "Based on your spending data, I can help you optimize your budget. What specific area would you like to focus on?",
            "I see you've been spending on food delivery. Cooking at home 2-3 times a week could save you ‚Ç∫200+ monthly.",
            "Your transportation costs seem reasonable. Have you considered public transport for additional savings?",
            "Great question! Let me analyze your recent transactions to provide personalized insights."
        ];
        
        const randomResponse = responses[Math.floor(Math.random() * responses.length)];
        
        const aiMessage = `
            <div style="margin-bottom: 16px;">
                <div style="
                    background-color: #27272a;
                    padding: 12px;
                    border-radius: 12px 12px 12px 4px;
                    margin-bottom: 4px;
                ">
                    <p style="color: #e4e4e7; font-size: 13px; line-height: 1.4;">${randomResponse}</p>
                </div>
                <p style="color: #71717a; font-size: 10px;">Just now</p>
            </div>
        `;
        
        chatContainer.innerHTML += aiMessage;
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }, 1000);
}

document.addEventListener('DOMContentLoaded', function() {
    if (spendingData.length > 0) {
        drawPieChart('spendingChart', spendingData, 'spendingLegend');
    }
    if (accountData.length > 0) {
        drawPieChart('accountChart', accountData, 'accountLegend');
    }
});
</script>
{% endblock %}